<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éë„Çπ„ÉØ„Éº„Éâ„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333333;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --result-bg: #e9ecef;
            --border-color: #dee2e6;
            --shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #bb86fc;
            --accent-hover: #9b65de;
            --result-bg: #2d2d2d;
            --border-color: #404040;
            --shadow: 0 8px 30px rgba(0,0,0,0.5);
        }

        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            margin: 0;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background: var(--container-bg);
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 420px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 { margin: 0; font-size: 1.4rem; font-weight: 700; }

        /* „ÉÜ„Éº„ÉûÂàáÊõø„Çπ„Ç§„ÉÉ„ÉÅ */
        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-color);
            border-radius: 20px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-family: inherit;
        }
        .theme-toggle:hover { border-color: var(--accent-color); }

        .result-wrapper { position: relative; margin-bottom: 15px; }
        
        .result-box {
            background: var(--result-bg);
            padding: 16px;
            padding-right: 50px;
            /* Ë¶ñË™çÊÄß„ÅÆÈ´ò„ÅÑ„Éï„Ç©„É≥„ÉàË®≠ÂÆö„ÇíËøΩÂä† */
            font-family: "SF Mono", "Consolas", "Monaco", monospace;
            font-feature-settings: "zero"; /* 0„Å´„Çπ„É©„ÉÉ„Ç∑„É•„ÇíÂÖ•„Çå„Çã */
            font-variant-ligatures: none;
            font-size: 1.2rem;
            border-radius: 8px;
            word-break: break-all;
            min-height: 28px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            color: var(--accent-color);
            font-weight: bold;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .copy-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            font-size: 1.2rem;
            color: var(--text-color);
            transition: background 0.2s;
        }
        .copy-btn:hover { background-color: rgba(128,128,128,0.2); }

        .copy-message {
            position: absolute;
            top: -35px;
            right: 0;
            background: var(--accent-color);
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }
        .copy-message.show { opacity: 1; transform: translateY(0); }

        /* Âº∑Â∫¶„É°„Éº„Çø„Éº */
        .strength-container { margin-bottom: 25px; }
        .strength-bar-bg {
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .strength-bar-fill { height: 100%; width: 0%; transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.4s; }
        .strength-text { font-size: 0.85rem; text-align: right; font-weight: 600; opacity: 0.9; }

        /* Ë®≠ÂÆö„Ç®„É™„Ç¢ */
        .settings { display: grid; gap: 12px; margin-bottom: 25px; }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child { border-bottom: none; }
        
        label { cursor: pointer; font-size: 0.95rem; }
        
        input[type="number"] {
            padding: 6px;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 60px;
            text-align: center;
            font-weight: bold;
        }
        input[type="checkbox"] { transform: scale(1.2); cursor: pointer; accent-color: var(--accent-color); }

        .generate-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--accent-color);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, filter 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-family: inherit;
        }
        .generate-btn:hover { filter: brightness(1.1); }
        .generate-btn:active { transform: scale(0.98); }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>„Éë„Çπ„ÉØ„Éº„ÉâÁîüÊàê v2</h2>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô „ÉÄ„Éº„ÇØ</button>
    </div>
    
    <div class="result-wrapper">
        <div class="result-box" id="passwordDisplay"></div>
        <button class="copy-btn" onclick="copyPassword()" title="„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº">üìã</button>
        <div class="copy-message" id="copyMsg">„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ</div>
    </div>

    <div class="strength-container">
        <div class="strength-bar-bg">
            <div class="strength-bar-fill" id="strengthBar"></div>
        </div>
        <div class="strength-text" id="strengthText">Ë®àÁÆó‰∏≠...</div>
    </div>

    <div class="settings">
        <div class="setting-item">
            <label for="length">ÊñáÂ≠óÊï∞ (4-128)</label>
            <input type="number" id="length" value="16" min="4" max="128" onchange="saveSettings()">
        </div>
        <div class="setting-item">
            <label for="useUpper">Â§ßÊñáÂ≠ó (A-Z)</label>
            <input type="checkbox" id="useUpper" checked onchange="saveSettings()">
        </div>
        <div class="setting-item">
            <label for="useNumbers">Êï∞Â≠ó (0-9)</label>
            <input type="checkbox" id="useNumbers" checked onchange="saveSettings()">
        </div>
        <div class="setting-item">
            <label for="useSymbols">Ë®òÂè∑ (!-#$)</label>
            <input type="checkbox" id="useSymbols" onchange="saveSettings()">
        </div>
        <div class="setting-item">
            <label for="excludeAmbiguous" title="1, l, I, 0, O, o, z, 2, | „Å™„Å©„ÇíÈô§Â§ñ„Åó„Åæ„Åô">Á¥õ„Çâ„Çè„Åó„ÅÑÊñáÂ≠ó„ÇíÈô§„Åè</label>
            <input type="checkbox" id="excludeAmbiguous" onchange="saveSettings()">
        </div>
        <div class="setting-item">
            <label for="useHyphens" title="4ÊñáÂ≠ó„Åî„Å®„Å´„Éè„Ç§„Éï„É≥„ÇíÂÖ•„Çå„Åæ„Åô">Ë™≠„Åø„ÇÑ„Åô„ÅèÂå∫Âàá„Çã ( - )</label>
            <input type="checkbox" id="useHyphens" onchange="saveSettings()">
        </div>
    </div>

    <button class="generate-btn" onclick="generatePassword()">ÁîüÊàê„Åô„Çã</button>
</div>

<script>
    window.onload = function() {
        loadSettings();
        generatePassword();
    };

    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('themeBtn');
        const isDark = body.getAttribute('data-theme') === 'dark';
        
        if (isDark) {
            body.removeAttribute('data-theme');
            btn.innerText = 'üåô „ÉÄ„Éº„ÇØ';
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            btn.innerText = '‚òÄÔ∏è „É©„Ç§„Éà';
            localStorage.setItem('theme', 'dark');
        }
    }

    function generatePassword() {
        const lengthInput = document.getElementById('length');
        let length = parseInt(lengthInput.value);
        if (length > 128) { length = 128; lengthInput.value = 128; }
        if (length < 4) { length = 4; lengthInput.value = 4; }

        const useUpper = document.getElementById('useUpper').checked;
        const useNumbers = document.getElementById('useNumbers').checked;
        const useSymbols = document.getElementById('useSymbols').checked;
        const excludeAmbiguous = document.getElementById('excludeAmbiguous').checked;
        const useHyphens = document.getElementById('useHyphens').checked;

        const lowerChars = 'abcdefghijklmnopqrstuvwxyz';
        const upperChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const numberChars = '0123456789';
        const symbolChars = '!@#$%^&*()_+-=[]{}|;:,.<>?';
        
        // Âº∑Âåñ„Åï„Çå„Åü„ÄåÁ¥õ„Çâ„Çè„Åó„ÅÑÊñáÂ≠ó„Äç„É™„Çπ„Éà
        const ambiguous = 'Il10OozZ2|'; 

        // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Áî®„Éò„É´„Éë„ÉºÈñ¢Êï∞
        const filterChars = (chars) => excludeAmbiguous ? chars.split('').filter(c => !ambiguous.includes(c)).join('') : chars;

        // „Åæ„Åö„ÄÅÂ∞èÊñáÂ≠ó„Éó„Éº„É´„Çí‰ΩúÊàê
        let allowedChars = filterChars(lowerChars);
        
        // ÂêÑÁ®Æ„Éó„Éº„É´„Çí‰ΩúÊàê„Åó„ÄÅÁµêÂêà„Åô„Çã
        // ÂêåÊôÇ„Å´„ÄåÊúÄ‰Ωé1ÊñáÂ≠ó„ÅØ„Åì„Çå„Çí‰Ωø„ÅÜ„Äç„Åü„ÇÅ„ÅÆÂº∑Âà∂„Éó„Éº„É´„ÇÇ‰Ωú„Çã
        let mandatoryPools = [];

        if (useUpper) {
            const filtered = filterChars(upperChars);
            allowedChars += filtered;
            if (filtered.length > 0) mandatoryPools.push(filtered);
        }
        if (useNumbers) {
            const filtered = filterChars(numberChars);
            allowedChars += filtered;
            if (filtered.length > 0) mandatoryPools.push(filtered);
        }
        if (useSymbols) {
            const filtered = filterChars(symbolChars);
            allowedChars += filtered;
            if (filtered.length > 0) mandatoryPools.push(filtered);
        }

        // ‰Ωï„ÇÇÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØ„Éï„Ç£„É´„Çø„ÅßÁ©∫„Å´„Å™„Å£„ÅüÂ†¥Âêà„ÅÆÂÆâÂÖ®Á≠ñ
        if (allowedChars === '') allowedChars = lowerChars;

        let passwordArray = [];
        const randomValues = new Uint32Array(length);
        window.crypto.getRandomValues(randomValues);

        // 1. ÂøÖÈ†àÊñáÂ≠óÁ®ÆÔºàÂ§ßÊñáÂ≠ó„ÄÅÊï∞Â≠ó„ÄÅË®òÂè∑Ôºâ„Åã„ÇâÊúÄ‰Ωé1ÊñáÂ≠ó„Åö„Å§Á¢∫‰øù
        let filledCount = 0;
        mandatoryPools.forEach(pool => {
            if (filledCount < length) {
                // randomValues„ÇíÊ∂àË≤ª„Åó„Å¶„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
                passwordArray.push(pool[randomValues[filledCount] % pool.length]);
                filledCount++;
            }
        });

        // 2. ÊÆã„Çä„ÅÆÊñáÂ≠óÊï∞„ÇíÂÖ®‰Ωì„ÅÆ„Éó„Éº„É´„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´Âüã„ÇÅ„Çã
        for (let i = filledCount; i < length; i++) {
            const randomIndex = randomValues[i] % allowedChars.length;
            passwordArray.push(allowedChars[randomIndex]);
        }

        // 3. ÈÖçÂàó„Çí„Ç∑„É£„ÉÉ„Éï„É´„Åô„ÇãÔºàÂøÖÈ†àÊñáÂ≠ó„ÅåÂÖàÈ†≠„Å´Âõ∫„Åæ„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´Ôºâ
        // „Éï„Ç£„ÉÉ„Ç∑„É£„Éº‚Äì„Ç§„Çß„Éº„ÉÑ„ÅÆ„Ç∑„É£„ÉÉ„Éï„É´
        for (let i = passwordArray.length - 1; i > 0; i--) {
            // „Ç∑„É£„ÉÉ„Éï„É´Áî®„Å´Á∞°Êòì‰π±Êï∞„Çí‰ΩøÁî®Ôºà„Åì„Åì„ÅØMath.random„ÅßÂçÅÂàÜÔºâ
            const j = Math.floor(Math.random() * (i + 1));
            [passwordArray[i], passwordArray[j]] = [passwordArray[j], passwordArray[i]];
        }

        let password = passwordArray.join('');

        if (useHyphens) {
            const parts = password.match(/.{1,4}/g);
            if (parts) password = parts.join('-');
        }

        document.getElementById('passwordDisplay').innerText = password;
        
        // „Ç®„É≥„Éà„É≠„Éî„ÉºË®àÁÆó„ÅØÂÖÉ„ÅÆÊñáÂ≠óÊï∞(length)„ÅßË°å„ÅÜ
        evaluateStrength(length, allowedChars.length);
    }

    function evaluateStrength(length, poolSize) {
        const entropy = length * Math.log2(poolSize);
        const bar = document.getElementById('strengthBar');
        const text = document.getElementById('strengthText');
        
        let color = '#dc3545';
        let label = 'Âç±Èô∫';
        let percent = 20;

        if (entropy > 120) {
            color = document.body.getAttribute('data-theme') === 'dark' ? '#bb86fc' : '#007bff';
            label = 'ÊúÄÂº∑ (Ëß£Ë™≠‰∏çËÉΩ)';
            percent = 100;
        } else if (entropy > 80) {
            color = '#28a745';
            label = 'ÂÆâÂÖ® (Âº∑Âäõ)';
            percent = 75;
        } else if (entropy > 50) {
            color = '#ffc107';
            label = 'ÊôÆÈÄö („Åæ„ÅÇ„Åæ„ÅÇ)';
            percent = 50;
        } else {
            label = 'Âç±Èô∫ (ËÑÜÂº±)';
        }

        bar.style.width = percent + '%';
        bar.style.backgroundColor = color;
        text.innerText = `${label} / ${Math.floor(entropy)} bits`;
        text.style.color = color;
    }

    function copyPassword() {
        const password = document.getElementById('passwordDisplay').innerText;
        if (!password) return;
        navigator.clipboard.writeText(password).then(() => {
            const msg = document.getElementById('copyMsg');
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 2000);
        });
    }

    function saveSettings() {
        const settings = {
            length: document.getElementById('length').value,
            useUpper: document.getElementById('useUpper').checked,
            useNumbers: document.getElementById('useNumbers').checked,
            useSymbols: document.getElementById('useSymbols').checked,
            excludeAmbiguous: document.getElementById('excludeAmbiguous').checked,
            useHyphens: document.getElementById('useHyphens').checked
        };
        localStorage.setItem('pwdSettings', JSON.stringify(settings));
    }

    function loadSettings() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeBtn').innerText = '‚òÄÔ∏è „É©„Ç§„Éà';
        }

        const saved = localStorage.getItem('pwdSettings');
        if (saved) {
            const settings = JSON.parse(saved);
            document.getElementById('length').value = settings.length;
            document.getElementById('useUpper').checked = settings.useUpper;
            document.getElementById('useNumbers').checked = settings.useNumbers;
            document.getElementById('useSymbols').checked = settings.useSymbols;
            if (settings.excludeAmbiguous !== undefined) document.getElementById('excludeAmbiguous').checked = settings.excludeAmbiguous;
            if (settings.useHyphens !== undefined) document.getElementById('useHyphens').checked = settings.useHyphens;
        }
    }
</script>

</body>
</html>
